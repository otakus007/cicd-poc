AWSTemplateFormatVersion: "2010-09-09"
Description: >
  ECS Task Definition Stack for CI/CD Pipeline.
  Creates a Fargate-compatible task definition with container configuration,
  health checks, CloudWatch Logs, and Secrets Manager integration.
  Requirements: 6.5 (CPU/memory limits), 8.4 (secrets injection), 7.1 (CloudWatch Logs)

# =============================================================================
# METADATA
# =============================================================================
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Environment Configuration"
        Parameters:
          - Environment
          - ProjectName
      - Label:
          default: "Container Configuration"
        Parameters:
          - ContainerImage
          - ContainerPort
          - TaskCpu
          - TaskMemory
      - Label:
          default: "Health Check Configuration"
        Parameters:
          - HealthCheckPath
          - HealthCheckInterval
          - HealthCheckTimeout
          - HealthCheckRetries
          - HealthCheckStartPeriod
      - Label:
          default: "Logging Configuration"
        Parameters:
          - LogRetentionDays
      - Label:
          default: "Cost Tracking Configuration"
        Parameters:
          - ComputeType
    ParameterLabels:
      Environment:
        default: "Deployment Environment"
      ProjectName:
        default: "Project Name"
      ContainerImage:
        default: "Container Image URI"
      ContainerPort:
        default: "Container Port"
      TaskCpu:
        default: "Task CPU Units"
      TaskMemory:
        default: "Task Memory (MB)"
      HealthCheckPath:
        default: "Health Check Path"
      HealthCheckInterval:
        default: "Health Check Interval (seconds)"
      HealthCheckTimeout:
        default: "Health Check Timeout (seconds)"
      HealthCheckRetries:
        default: "Health Check Retries"
      HealthCheckStartPeriod:
        default: "Health Check Start Period (seconds)"
      LogRetentionDays:
        default: "Log Retention (days)"
      ComputeType:
        default: "Compute Type for Cost Tracking"

# =============================================================================
# PARAMETERS
# =============================================================================
Parameters:
  Environment:
    Type: String
    Description: Deployment environment (dev, staging, prod)
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    ConstraintDescription: Must be dev, staging, or prod

  ProjectName:
    Type: String
    Description: Project name used for resource naming
    Default: japfa-api
    AllowedPattern: ^[a-z0-9][a-z0-9-]*[a-z0-9]$
    MinLength: 3
    MaxLength: 32
    ConstraintDescription: Must be lowercase alphanumeric with hyphens, 3-32 characters

  ContainerImage:
    Type: String
    Description: >
      ECR image URI for the container. Use placeholder for initial deployment,
      then update via CI/CD pipeline. Format: {account}.dkr.ecr.{region}.amazonaws.com/{repo}:{tag}
    Default: "PLACEHOLDER_IMAGE_URI"

  ContainerPort:
    Type: Number
    Description: Port exposed by the container for the .NET application
    Default: 8080
    MinValue: 1
    MaxValue: 65535
    ConstraintDescription: Must be a valid port number (1-65535)

  TaskCpu:
    Type: String
    Description: >
      CPU units for the Fargate task (256, 512, 1024, 2048, 4096).
      512 CPU units = 0.5 vCPU, suitable for .NET 10 Web API.
    Default: "512"
    AllowedValues:
      - "256"
      - "512"
      - "1024"
      - "2048"
      - "4096"
    ConstraintDescription: Must be a valid Fargate CPU configuration

  TaskMemory:
    Type: String
    Description: >
      Memory (MB) for the Fargate task. Must be compatible with CPU selection.
      1024 MB = 1 GB, suitable for .NET 10 Web API with 512 CPU units.
    Default: "1024"
    AllowedValues:
      # 256 CPU: 512, 1024, 2048
      - "512"
      - "1024"
      - "2048"
      # 512 CPU: 1024, 2048, 3072, 4096
      - "3072"
      - "4096"
      # 1024 CPU: 2048, 3072, 4096, 5120, 6144, 7168, 8192
      - "5120"
      - "6144"
      - "7168"
      - "8192"
    ConstraintDescription: Must be a valid Fargate memory configuration compatible with CPU

  HealthCheckPath:
    Type: String
    Description: HTTP path for container health check endpoint
    Default: /health
    AllowedPattern: ^/.*$
    ConstraintDescription: Must start with forward slash

  HealthCheckInterval:
    Type: Number
    Description: Seconds between health checks
    Default: 30
    MinValue: 5
    MaxValue: 300
    ConstraintDescription: Must be between 5 and 300 seconds

  HealthCheckTimeout:
    Type: Number
    Description: Seconds to wait for health check response
    Default: 5
    MinValue: 2
    MaxValue: 60
    ConstraintDescription: Must be between 2 and 60 seconds

  HealthCheckRetries:
    Type: Number
    Description: Number of consecutive health check failures before marking unhealthy
    Default: 3
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: Must be between 1 and 10 retries

  HealthCheckStartPeriod:
    Type: Number
    Description: Seconds to wait before starting health checks (container startup grace period)
    Default: 60
    MinValue: 0
    MaxValue: 300
    ConstraintDescription: Must be between 0 and 300 seconds

  LogRetentionDays:
    Type: Number
    Description: Number of days to retain CloudWatch Logs
    Default: 30
    AllowedValues:
      - 1
      - 3
      - 5
      - 7
      - 14
      - 30
      - 60
      - 90
      - 120
      - 150
      - 180
      - 365
      - 400
      - 545
      - 731
      - 1827
      - 3653
    ConstraintDescription: Must be a valid CloudWatch Logs retention period

  ComputeType:
    Type: String
    Description: Compute type for cost allocation tagging (fargate or ec2)
    Default: fargate
    AllowedValues:
      - fargate
      - ec2
    ConstraintDescription: Must be fargate or ec2

# =============================================================================
# CONDITIONS
# =============================================================================
Conditions:
  IsProduction: !Equals [!Ref Environment, prod]
  IsStaging: !Equals [!Ref Environment, staging]
  IsDevelopment: !Equals [!Ref Environment, dev]

# =============================================================================
# RESOURCES
# =============================================================================
Resources:
  # ---------------------------------------------------------------------------
  # CloudWatch Log Group for Container Logs
  # Purpose: Centralized logging for ECS container output
  # Requirement 7.1: Pipeline SHALL log all stage transitions and execution
  #                  details to CloudWatch Logs
  # ---------------------------------------------------------------------------
  TaskLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/${ProjectName}-${Environment}-task
      RetentionInDays: !If
        - IsProduction
        - 90
        - !If
          - IsStaging
          - 60
          - !Ref LogRetentionDays
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-task-logs
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName
        - Key: Purpose
          Value: ECS Task Container Logs
        # Requirement 3.2: ComputeType tag for cost tracking
        - Key: ComputeType
          Value: !Ref ComputeType

  # ---------------------------------------------------------------------------
  # ECS Task Definition
  # Purpose: Defines the container configuration for Fargate deployment
  # Requirement 6.5: Task_Definition SHALL configure appropriate CPU and memory
  #                  limits for the .NET application
  # Requirement 8.4: ECS_Fargate SHALL inject secrets as environment variables
  #                  from Secrets Manager
  # Requirement 7.1: CloudWatch Logs configuration for container logging
  # ---------------------------------------------------------------------------
  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DependsOn: TaskLogGroup
    Properties:
      Family: !Sub ${ProjectName}-${Environment}-task
      # Fargate launch type requirements
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      # CPU and Memory configuration
      # Requirement 6.5: Configure appropriate CPU (512) and memory (1024) limits
      Cpu: !Ref TaskCpu
      Memory: !Ref TaskMemory
      # IAM Roles
      # ExecutionRoleArn: Used by ECS agent to pull images and retrieve secrets
      # TaskRoleArn: Used by the application at runtime for AWS API calls
      ExecutionRoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/${ProjectName}-${Environment}-ecs-execution-role
      TaskRoleArn: !Sub arn:aws:iam::${AWS::AccountId}:role/${ProjectName}-${Environment}-ecs-task-role
      # Runtime platform for Fargate
      RuntimePlatform:
        CpuArchitecture: X86_64
        OperatingSystemFamily: LINUX
      # Container definitions
      ContainerDefinitions:
        - Name: !Sub ${ProjectName}-${Environment}
          # Container image - updated by CI/CD pipeline
          Image: !Ref ContainerImage
          Essential: true
          # Port mappings for the .NET application
          PortMappings:
            - ContainerPort: !Ref ContainerPort
              Protocol: tcp
              # AppProtocol for Service Connect (optional)
              AppProtocol: http
          # Health check configuration
          # Uses curl to check the /health endpoint
          HealthCheck:
            Command:
              - CMD-SHELL
              - !Sub curl -f http://localhost:${ContainerPort}${HealthCheckPath} || exit 1
            Interval: !Ref HealthCheckInterval
            Timeout: !Ref HealthCheckTimeout
            Retries: !Ref HealthCheckRetries
            StartPeriod: !Ref HealthCheckStartPeriod
          # CloudWatch Logs configuration
          # Requirement 7.1: Log all execution details to CloudWatch Logs
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref TaskLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
              # Enable multiline log handling for .NET stack traces
              awslogs-datetime-format: "%Y-%m-%d %H:%M:%S"
          # Secrets injection from Secrets Manager
          # Requirement 8.4: Inject secrets as environment variables
          Secrets:
            # Database connection string for PoultrySale database
            - Name: ConnectionStrings__PoultrySale
              ValueFrom: !Sub
                - "arn:aws:secretsmanager:${Region}:${Account}:secret:${Project}/${Env}/db/connection-strings:ConnectionStrings__PoultrySale::"
                - Region: !Ref AWS::Region
                  Account: !Ref AWS::AccountId
                  Project: !Ref ProjectName
                  Env: !Ref Environment
            # Database connection string for MasterDb database
            - Name: ConnectionStrings__MasterDb
              ValueFrom: !Sub
                - "arn:aws:secretsmanager:${Region}:${Account}:secret:${Project}/${Env}/db/connection-strings:ConnectionStrings__MasterDb::"
                - Region: !Ref AWS::Region
                  Account: !Ref AWS::AccountId
                  Project: !Ref ProjectName
                  Env: !Ref Environment
          # Environment variables (non-sensitive configuration)
          Environment:
            - Name: ASPNETCORE_ENVIRONMENT
              Value: !If
                - IsProduction
                - Production
                - !If
                  - IsStaging
                  - Staging
                  - Development
            - Name: ASPNETCORE_URLS
              Value: !Sub http://+:${ContainerPort}
            # Disable .NET telemetry in container
            - Name: DOTNET_CLI_TELEMETRY_OPTOUT
              Value: "1"
            # Enable detailed errors in non-production
            - Name: ASPNETCORE_DETAILEDERRORS
              Value: !If
                - IsProduction
                - "false"
                - "true"
          # Resource limits (soft limits for container)
          # Hard limits are set at task level via Cpu and Memory
          Cpu: 0
          MemoryReservation: !If
            - IsProduction
            - 768
            - 512
          # Disable privileged mode for security
          Privileged: false
          # Read-only root filesystem (recommended for security)
          # Note: Disabled for .NET as it may need temp file access
          ReadonlyRootFilesystem: false
          # Linux parameters
          LinuxParameters:
            InitProcessEnabled: true
          # Ulimits for .NET application
          Ulimits:
            - Name: nofile
              SoftLimit: 65536
              HardLimit: 65536
      # Task definition tags
      Tags:
        - Key: Name
          Value: !Sub ${ProjectName}-${Environment}-task-definition
        - Key: Environment
          Value: !Ref Environment
        - Key: Project
          Value: !Ref ProjectName
        - Key: Purpose
          Value: ECS Fargate Task Definition
        # Requirement 3.2: ComputeType tag for cost tracking
        - Key: ComputeType
          Value: !Ref ComputeType

# =============================================================================
# OUTPUTS
# =============================================================================
Outputs:
  # Task Definition Outputs
  TaskDefinitionArn:
    Description: ARN of the ECS Task Definition
    Value: !Ref TaskDefinition
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskDefinitionArn

  TaskDefinitionFamily:
    Description: Family name of the ECS Task Definition
    Value: !Sub ${ProjectName}-${Environment}-task
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskDefinitionFamily

  TaskDefinitionRevision:
    Description: Current revision of the Task Definition
    Value: !Select [6, !Split [":", !Ref TaskDefinition]]
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskDefinitionRevision

  # Container Configuration Outputs
  ContainerName:
    Description: Name of the container in the task definition
    Value: !Sub ${ProjectName}-${Environment}
    Export:
      Name: !Sub ${ProjectName}-${Environment}-ContainerName

  ContainerPort:
    Description: Port exposed by the container
    Value: !Ref ContainerPort
    Export:
      Name: !Sub ${ProjectName}-${Environment}-ContainerPort

  # Resource Configuration Outputs
  TaskCpu:
    Description: CPU units allocated to the task
    Value: !Ref TaskCpu
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskCpu

  TaskMemory:
    Description: Memory (MB) allocated to the task
    Value: !Ref TaskMemory
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskMemory

  # Health Check Configuration Outputs
  HealthCheckPath:
    Description: Health check endpoint path
    Value: !Ref HealthCheckPath
    Export:
      Name: !Sub ${ProjectName}-${Environment}-HealthCheckPath

  HealthCheckCommand:
    Description: Health check command used by the container
    Value: !Sub "curl -f http://localhost:${ContainerPort}${HealthCheckPath} || exit 1"
    Export:
      Name: !Sub ${ProjectName}-${Environment}-HealthCheckCommand

  # Log Group Outputs
  TaskLogGroupArn:
    Description: ARN of the CloudWatch Log Group for task logs
    Value: !GetAtt TaskLogGroup.Arn
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskLogGroupArn

  TaskLogGroupName:
    Description: Name of the CloudWatch Log Group for task logs
    Value: !Ref TaskLogGroup
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskLogGroupName

  # IAM Role References
  ExecutionRoleArn:
    Description: ARN of the ECS Execution Role used by this task
    Value: !Sub arn:aws:iam::${AWS::AccountId}:role/${ProjectName}-${Environment}-ecs-execution-role
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskExecutionRoleArn

  TaskRoleArn:
    Description: ARN of the ECS Task Role used by this task
    Value: !Sub arn:aws:iam::${AWS::AccountId}:role/${ProjectName}-${Environment}-ecs-task-role
    Export:
      Name: !Sub ${ProjectName}-${Environment}-TaskTaskRoleArn

  # Secrets References
  SecretsConfiguration:
    Description: Summary of secrets injected into the container
    Value: !Sub |
      Secrets injected from Secrets Manager:
      - ConnectionStrings__PoultrySale: ${ProjectName}/${Environment}/db/connection-strings
      - ConnectionStrings__MasterDb: ${ProjectName}/${Environment}/db/connection-strings
